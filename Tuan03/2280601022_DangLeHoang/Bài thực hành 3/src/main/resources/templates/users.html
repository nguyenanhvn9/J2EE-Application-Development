<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Quản lý người dùng</title>
    <script>
        let allSearchResults = [];
        let currentPage = 1;
        const pageSize = 5;

        function renderUsers(users) {
            var tbody = document.getElementById('users-tbody');
            tbody.innerHTML = '';
            users.forEach(function(user) {
                var row = `<tr>
                    <td>${user.id}</td>
                    <td>${user.name}</td>
                    <td>${user.username}</td>
                    <td>${user.email}</td>
                    <td>${user.phone}</td>
                    <td>
                        <button onclick="showEditForm(${user.id})">Sửa</button>
                        <button onclick="deleteUser(${user.id})">Xoá</button>
                    </td>
                </tr>`;
                tbody.innerHTML += row;
            });
        }

        function renderPagination(total, current) {
            var container = document.getElementById('pagination');
            container.innerHTML = '';
            for (let i = 1; i <= total; i++) {
                if (i === current) {
                    container.innerHTML += `<strong>${i}</strong> `;
                } else {
                    container.innerHTML += `<a href="#" onclick="goToPage(${i});return false;">${i}</a> `;
                }
            }
        }

        function goToPage(page) {
            currentPage = page;
            const start = (page - 1) * pageSize;
            const end = start + pageSize;
            renderUsers(allSearchResults.slice(start, end));
            renderPagination(Math.ceil(allSearchResults.length / pageSize), page);
        }

        function doSearch() {
            const keyword = document.getElementById('searchInput').value;
            fetch(`/api/users`)
                .then(response => response.json())
                .then(data => {
                    allSearchResults = data.filter(u =>
                        u.name.toLowerCase().includes(keyword.toLowerCase()) ||
                        u.username.toLowerCase().includes(keyword.toLowerCase()) ||
                        u.email.toLowerCase().includes(keyword.toLowerCase()) ||
                        u.phone.toLowerCase().includes(keyword.toLowerCase())
                    );
                    goToPage(1);
                });
            return false;
        }

        function reloadUsers() {
            fetch('/api/users')
                .then(response => response.json())
                .then(data => {
                    allSearchResults = data;
                    goToPage(1);
                });
        }

        function showAddForm() {
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';
            document.getElementById('formTitle').innerText = 'Thêm người dùng';
            document.getElementById('userFormContainer').style.display = 'block';
        }

        function showEditForm(id) {
            const user = allSearchResults.find(u => u.id === id);
            if (user) {
                document.getElementById('userId').value = user.id;
                document.getElementById('name').value = user.name;
                document.getElementById('username').value = user.username;
                document.getElementById('email').value = user.email;
                document.getElementById('phone').value = user.phone;
                document.getElementById('formTitle').innerText = 'Sửa người dùng';
                document.getElementById('userFormContainer').style.display = 'block';
            }
        }

        function hideForm() {
            document.getElementById('userFormContainer').style.display = 'none';
        }

        function saveUser() {
            const id = document.getElementById('userId').value;
            const user = {
                name: document.getElementById('name').value,
                username: document.getElementById('username').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value
            };
            let method, url;
            if (id) {
                method = 'PUT';
                url = `/api/users/${id}`;
            } else {
                method = 'POST';
                url = '/api/users';
            }
            fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(user)
            }).then(() => {
                hideForm();
                reloadUsers();
            });
            return false;
        }

        function deleteUser(id) {
            if (confirm('Bạn có chắc muốn xoá?')) {
                fetch(`/api/users/${id}`, { method: 'DELETE' })
                    .then(() => reloadUsers());
            }
        }

        window.onload = function() {
            reloadUsers();
        }
    </script>
    <style>
        #userFormContainer { display: none; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
    </style>
</head>
<body>
    <h1>Quản lý người dùng</h1>
    <form onsubmit="return doSearch();">
        <input type="text" id="searchInput" placeholder="Tìm kiếm theo tên, username, email hoặc số điện thoại..." />
        <button type="submit">Tìm kiếm</button>
    </form>
    <button onclick="showAddForm()">Thêm người dùng</button>
    <div id="userFormContainer">
        <h3 id="formTitle">Thêm người dùng</h3>
        <form id="userForm" onsubmit="return saveUser();">
            <input type="hidden" id="userId" />
            <label>Họ tên: <input type="text" id="name" required /></label><br/>
            <label>Username: <input type="text" id="username" required /></label><br/>
            <label>Email: <input type="email" id="email" required /></label><br/>
            <label>Phone: <input type="text" id="phone" required /></label><br/>
            <button type="submit">Lưu</button>
            <button type="button" onclick="hideForm()">Huỷ</button>
        </form>
    </div>
    <table border="1">
        <tr>
            <th>ID</th>
            <th>Họ tên</th>
            <th>Username</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Hành động</th>
        </tr>
        <tbody id="users-tbody">
        </tbody>
    </table>
    <div id="pagination" style="margin-top:10px;"></div>
</body>
</html> 