<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <title>TechShop - Chi tiết sản phẩm</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    /* Add styles for star ratings */
    .star-rating {
      color: #ffd700; /* Gold color for stars */
      font-size: 1.2em;
    }
    .star-rating .fa-star-half-alt {
      position: relative;
      display: inline-block;
    }
    .star-rating .fa-star-half-alt::before {
      content: "\f089"; /* Unicode for half-star */
      position: absolute;
      width: 50%;
      overflow: hidden;
    }

    /* Styles for the review form */
    .rating-stars {
      display: inline-block;
      font-size: 1.5em;
    }
    .rating-stars input[type="radio"] {
      display: none;
    }
    .rating-stars label {
      color: #ddd; /* Light gray for unselected stars */
      cursor: pointer;
      transition: color 0.2s ease-in-out;
    }
    .rating-stars label:hover,
    .rating-stars label:hover ~ label,
    .rating-stars input[type="radio"]:checked ~ label {
      color: #ffd700; /* Gold for selected and hovered stars */
    }
  </style>
</head>
<body>


<div class="container mt-4">
  <div th:if="${product != null}">
    <div class="row">
      <div class="col-md-5">
        <img th:src="${product.imageUrl} ?: 'https://via.placeholder.com/400x400?text=No+Image'" class="img-fluid rounded" alt="Product Image">
      </div>
      <div class="col-md-7">
        <h1 th:text="${product.name}">Tên sản phẩm</h1>
        <p class="text-muted"><span th:text="${product.category != null ? product.category.name : 'N/A'}">Danh mục</span></p>

        <div class="mb-3">
          <strong>Đánh giá trung bình: </strong>
          <span class="star-rating">
            <span th:each="i : ${#numbers.sequence(1, 5)}">
                <i th:class="${i <= product.averageRating} ? 'fas fa-star' : (${i - 0.5 <= product.averageRating} ? 'fas fa-star-half-alt' : 'far fa-star')"></i>
            </span>
          </span>
          <span class="text-muted" th:text="${#numbers.formatDecimal(product.averageRating, 0, 1) + ' (' + reviews.size() + ' đánh giá)'}"> (4.5 / 5 sao - 10 đánh giá)</span>
        </div>

        <h3 class="text-danger" th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT')} + ' VND'">Giá sản phẩm</h3>
        <p><strong>Tình trạng:</strong> <span th:class="${product.stockQuantity > 0 ? 'text-success' : 'text-danger'}" th:text="${product.stockQuantity > 0 ? 'Còn hàng (' + product.stockQuantity + ')' : 'Hết hàng'}">Còn hàng (100)</span></p>

        <p th:text="${product.description}">Mô tả chi tiết sản phẩm...</p>

        <form th:action="@{/customer/cart/add}" method="post" class="d-flex align-items-center">
          <input type="hidden" name="productId" th:value="${product.id}">
          <div class="input-group w-auto me-3">
            <button type="button" class="btn btn-outline-secondary" onclick="this.parentNode.querySelector('input[type=number]').stepDown()">-</button>
            <input type="number" name="quantity" class="form-control text-center" value="1" min="1" th:max="${product.stockQuantity}" style="width: 70px;">
            <button type="button" class="btn btn-outline-secondary" onclick="this.parentNode.querySelector('input[type=number]').stepUp()">+</button>
          </div>
          <button type="submit" class="btn btn-primary" th:disabled="${product.stockQuantity <= 0}">
            <i class="fas fa-shopping-cart"></i> Thêm vào giỏ hàng
          </button>
          <button type="submit" name="buyNow" value="true" class="btn btn-success ms-2" th:disabled="${product.stockQuantity <= 0}">
            Mua ngay
          </button>
        </form>
      </div>
    </div>
  </div>
</div>
    <hr class="my-4">

    <div id="reviewsSection">
      <h3 class="mb-3">Đánh giá sản phẩm</h3>

      <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
        <span th:text="${successMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
      <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <span th:text="${errorMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>

      <div class="card mb-4">
        <div class="card-header">
          <h5>Gửi đánh giá của bạn</h5>
        </div>
        <div class="card-body">
          <div th:if="${!isAuthenticated}" class="alert alert-info">
            Bạn cần <a href="/login">đăng nhập</a> để gửi đánh giá.
          </div>
          <div th:if="${isAuthenticated and !hasPurchased}" class="alert alert-warning">
            Bạn cần mua sản phẩm này và đơn hàng phải được giao để có thể đánh giá.
          </div>
          <div th:if="${isAuthenticated and hasPurchased and hasReviewed}" class="alert alert-info">
            Bạn đã đánh giá sản phẩm này.
            <div th:if="${existingReview != null}">
              <p><strong>Điểm của bạn:</strong>
                <span class="star-rating">
                        <span th:each="i : ${#numbers.sequence(1, 5)}">
                            <i th:class="${i <= existingReview.rating} ? 'fas fa-star' : 'far fa-star'"></i>
                        </span>
                    </span>
              </p>
              <p><strong>Bình luận của bạn:</strong> <span th:text="${existingReview.comment}"></span></p>
            </div>
          </div>

          <div th:if="${isAuthenticated and hasPurchased and !hasReviewed}">
            <form th:action="@{/product/{productId}/submit-review(productId=${product.id})}" method="post">
              <div class="mb-3">
                <label class="form-label">Xếp hạng:</label> <div class="rating-stars">
                <input type="radio" id="star5" name="rating" value="5" required/><label for="star5" title="5 sao"><i class="fas fa-star"></i></label>
                <input type="radio" id="star4" name="rating" value="4"/><label for="star4" title="4 sao"><i class="fas fa-star"></i></label>
                <input type="radio" id="star3" name="rating" value="3"/><label for="star3" title="3 sao"><i class="fas fa-star"></i></label>
                <input type="radio" id="star2" name="rating" value="2"/><label for="star2" title="2 sao"><i class="fas fa-star"></i></label>
                <input type="radio" id="star1" name="rating" value="1"/><label for="star1" title="1 sao"><i class="fas fa-star"></i></label>
              </div>
              </div>
              <div class="mb-3">
                <label for="comment" class="form-label">Bình luận (tùy chọn):</label>
                <textarea class="form-control" id="comment" name="comment" rows="3" placeholder="Viết bình luận của bạn tại đây..."></textarea>
              </div>
              <button type="submit" class="btn btn-success">Gửi đánh giá</button>
            </form>
          </div>
        </div>
      </div>

      <div th:if="${reviews.isEmpty()}" class="alert alert-info">
        Chưa có đánh giá nào cho sản phẩm này. Hãy là người đầu tiên!
      </div>
      <div th:unless="${reviews.isEmpty()}">
        <ul class="list-group list-group-flush">
          <li class="list-group-item" th:each="review : ${reviews}">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div>
                <strong><span th:text="${review.user.fullName}"></span></strong>
                <span class="text-muted ms-2" th:text="${#temporals.format(review.createdAt, 'dd-MM-yyyy HH:mm')}"></span>
              </div>
              <div class="star-rating">
                <span th:each="i : ${#numbers.sequence(1, 5)}">
                  <i th:class="${i <= review.rating} ? 'fas fa-star' : 'far fa-star'"></i>
                </span>
              </div>
            </div>
            <p th:text="${review.comment}"></p>
          </li>
        </ul>
      </div>
    </div>
  </div>
  <div th:if="${product == null}" class="alert alert-warning">
    <p>Không tìm thấy sản phẩm này.</p>
    <a href="/" class="btn btn-primary">Quay lại trang chủ</a>
  </div>
</div>

<footer class="bg-light text-center py-3 mt-4">
  <p>© 2025 TechShop. All rights reserved.</p>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>